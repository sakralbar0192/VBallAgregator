# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ–≤—å—é: –§–∞–∑–∞ 2 "–Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã –∏–≥—Ä"

## üéØ **–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –æ–±–ª–∞—Å—Ç—å —Ä–µ–≤—å—é** 

**–§–∞–∑–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** –ù–µ–¥–µ–ª–∏ 4-7 (–°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä ‚Üí –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å–∏ ‚Üí –õ–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è ‚Üí –ë–∞–∑–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)  
**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:** –ü–æ–ª–Ω—ã–π –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∏–≥—Ä—ã –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

---

## üìä **–û—Ü–µ–Ω–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø–ª–∞–Ω—É**

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|----------|---------|------------|
| **–°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä** | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ | –ú–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è —á–µ—Ä–µ–∑ –±–æ—Ç–∞ —Å –≤—ã–±–æ—Ä–æ–º –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏/—É—Ä–æ–≤–Ω—è |
| **–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å–∏** | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ | Advisory locks, FIFO –¥–ª—è waitlist |
| **–õ–∏—Å—Ç –æ–∂–∏–¥–∞–Ω–∏—è** | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ | –ê–≤—Ç–æ–ø—Ä–æ–º–æ—É—à–µ–Ω –ø—Ä–∏ –æ—Ç–∫–∞–∑–∞—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ |
| **–ë–∞–∑–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** | ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ | Event-driven —Å–∏—Å—Ç–µ–º–∞ —Å handlers |
| **Race conditions** | ‚úÖ –†–µ—à–µ–Ω–æ | PostgreSQL advisory locks |

**–ü–æ–∫—Ä—ã—Ç–∏–µ –ø–ª–∞–Ω–∞:** ‚úÖ **100%** ‚Äì –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Ñ–∞–∑—ã 2 —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã

---

## üèóÔ∏è **–ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π**

### ‚úÖ **–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã**

#### **Domain-Driven Design**
```typescript
// –ß–µ—Ç–∫–∏–µ –∞–≥—Ä–µ–≥—Ä–∞—Ç—ã —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π
class Game {
  ensureCanJoin(confirmedCount: number) {
    if (this.status !== GameStatus.open) 
      throw new DomainError(ERROR_CODES.GAME_NOT_OPEN);
  }
  
  get isPaymentWindowOpen(): boolean {
    return new Date() >= this.startsAt;
  }
}
```

#### **Event-Driven Architecture**
```typescript
// –°–ª–∞–±–∞—è —Å–≤—è–∑–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è
await eventPublisher.publish(evt('PlayerJoined', { gameId, userId, status }));
await eventPublisher.publish(evt('WaitlistedPromoted', { gameId, userId }));
```

#### **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
```typescript
return prisma.$transaction(async (tx) => {
  await tx.$executeRaw`SELECT pg_advisory_xact_lock(hashtext(${gameId}))`;
  // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
});
```

#### **Repository Pattern**
–ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–æ–º–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ –∏ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ü–∏–∏ —á–µ—Ä–µ–∑ [`PrismaGameRepo`](src/infrastructure/repositories.ts:19) –∏ [`PrismaRegistrationRepo`](src/infrastructure/repositories.ts:64)

### ‚ö†Ô∏è **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**

#### **1. "Fake" –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (HIGH Impact)**
```typescript
// –ü–†–û–ë–õ–ï–ú–ê: –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
const reminder24hTime = addHours(game.startsAt, -24);
if (reminder24hTime > new Date()) {
  await eventPublisher.publish(evt('GameReminder24h', { gameId }));  // ‚ùå –°—Ä–∞–∑—É!
}
```
**–†–∏—Å–∫:** –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏

#### **2. Hardcoded —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å (MEDIUM Impact)**
```typescript
// –ü–†–û–ë–õ–ï–ú–ê: Asia/Irkutsk –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω –ø–æ–≤—Å—é–¥—É
timeZone: 'Asia/Irkutsk' // ‚ùå –ù–µ configurable
```

#### **3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ç—Ä–∏–∫ (LOW Impact)**
```typescript
// –ü–†–û–ë–õ–ï–ú–ê: –ù–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏
await this.bot.telegram.sendMessage(chatId, text); // ‚ùå Fire-and-forget
```

---

## üîç **–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞**

### ‚úÖ **–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã**

#### **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
```typescript
if (!gameId?.trim()) {
  throw new DomainError('INVALID_INPUT', 'gameId –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
}
```

#### **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
```typescript
logger.info('joinGame called', { gameId, userId });
logger.info('User joined game', { gameId, userId, status });
```

#### **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤**
- ‚úÖ Race conditions
- ‚úÖ Capacity overflow 
- ‚úÖ Payment window enforcement
- ‚úÖ Waitlist promotion

### ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º—ã –∫–∞—á–µ—Å—Ç–≤–∞**

#### **1. –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**
```typescript
// –ü–†–û–ë–õ–ï–ú–ê: Use case –∑–Ω–∞–µ—Ç –æ Prisma –∏ —Å–æ–±—ã—Ç–∏—è—Ö
export async function markPayment(gameId: string, userId: string) {
  // –î–æ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
  reg.markPaid(game);
  // –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ü–∏—è 
  await registrationRepo.upsert(reg);
  // –°–æ–±—ã—Ç–∏—è
  await eventPublisher.publish(evt('PaymentMarked', { gameId, userId }));
  // –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
  await schedulePaymentReminders(gameId);  // ‚ùå –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
}
```

#### **2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç**
```typescript
// –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ 5+ –º–µ—Å—Ç–∞—Ö
const gameTime = game.startsAt.toLocaleDateString('ru-RU', {
  day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit',
  timeZone: 'Asia/Irkutsk' // ‚ùå Copy-paste –∫–æ–¥
});
```

#### **3. –°–º–µ—à–µ–Ω–∏–µ UI –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –≤ –±–æ—Ç–µ**
```typescript
// 200+ —Å—Ç—Ä–æ–∫ –º–∞—Å—Ç–µ—Ä–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã –≤ bot.ts ‚ùå
```

---

## üöÄ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** 

### ‚úÖ **–•–æ—Ä–æ—à–∏–µ —Ä–µ—à–µ–Ω–∏—è**
- **Advisory locks** –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç race conditions
- **Database indices** –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª—è—Ö
- **User caching** —Å TTL –≤ event publisher

### ‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞**
- **N+1 –∑–∞–ø—Ä–æ—Å—ã** –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö (–Ω–µ—Ç batch operations)
- **–ë–ª–æ–∫–∏—Ä—É—é—â–∏–π event publisher** (–±–µ–∑ retry/circuit breaker)
- **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ connection pooling**

---

## üìã **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º**

### üî• **HIGH IMPACT (–ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞)**

#### **1. –†–µ–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á**
```typescript
// –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê:
import { Queue, Worker } from 'bullmq';

export async function scheduleGameReminders(gameId: string) {
  await reminderQueue.add('game-reminder-24h', 
    { gameId }, 
    { delay: getDelayUntil(addHours(game.startsAt, -24)) }
  );
}
```
**–ü—Ä–∏—á–∏–Ω–∞:** –¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç, –∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è

#### **2. Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**
```typescript
// –î–û–ë–ê–í–ò–¢–¨:
async sendMessage(chatId: number, text: string, retries = 3): Promise<void> {
  for (let attempt = 0; attempt <= retries; attempt++) {
    try {
      await this.bot.telegram.sendMessage(chatId, text);
      return;
    } catch (error) {
      if (attempt === retries) throw error;
      await sleep(Math.pow(2, attempt) * 1000);
    }
  }
}
```

### ‚öôÔ∏è **MEDIUM IMPACT (–î–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)**

#### **3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–∞—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è**
```typescript
// –°–û–ó–î–ê–¢–¨:
interface UserPreferences {
  timezone: string;
  locale: string;
}

function formatGameTime(date: Date, userTz: string) {
  return date.toLocaleDateString('ru-RU', {
    timeZone: userTz || 'UTC'
  });
}
```

#### **4. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–æ—Ç–∞**
- –í—ã–¥–µ–ª–∏—Ç—å [`GameCreationWizard`](src/bot.ts:169) –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å
- –°–æ–∑–¥–∞—Ç—å [`CommandHandlers`](src/bot.ts:65) –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–∞–Ω–¥

### üìä **LOW IMPACT (–ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)**

#### **5. –¢—Ä–µ–∫–∏–Ω–≥ –¥–æ—Å—Ç–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π**
```typescript
interface NotificationMetrics {
  sent: number;
  delivered: number; 
  failed: number;
  retries: number;
}
```

---

## üéØ **–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞**

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|---------|-------------|
| **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** | üü¢ 9/10 | –í—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã |
| **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** | üü° 7/10 | DDD –ø—Ä–∏–Ω—Ü–∏–ø—ã —Å–æ–±–ª—é–¥–µ–Ω—ã, –Ω–æ –µ—Å—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏—è SRP |  
| **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** | üü° 6/10 | Race conditions —Ä–µ—à–µ–Ω—ã, –Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ fake |
| **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** | üü¢ 8/10 | –•–æ—Ä–æ—à–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—É—Ç–µ–π |
| **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å** | üü° 7/10 | –ß–∏—Å—Ç—ã–π –∫–æ–¥, –Ω–æ –º–Ω–æ–≥–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è |

### **üö¶ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –¥–µ–ø–ª–æ—é**
- ‚úÖ **Alpha-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –ì–æ—Ç–æ–≤–æ (–±–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–∞–±–æ—Ç–∞–µ—Ç)
- ‚ö†Ô∏è **Beta-–∑–∞–ø—É—Å–∫** ‚Äî –¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞  
- ‚ùå **Production** ‚Äî –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### **üèÜ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏**
1. **–ù–µ–¥–µ–ª—è 1:** –í–Ω–µ–¥—Ä–∏—Ç—å BullMQ –¥–ª—è real-time –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
2. **–ù–µ–¥–µ–ª—è 2:** –î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π  
3. **–ù–µ–¥–µ–ª—è 3:** –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–æ—Ç–∞ –∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è

**–ö–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** –•–æ—Ä–æ—à–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –±–∞–∑–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã–º–∏ –ø—Ä–æ–±–ª–µ–º–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –ø—Ä–æ–¥–∞–∫—à–Ω-–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å.