# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ä–µ–≤—å—é: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –æ–±—â–∞—è –æ—Ü–µ–Ω–∫–∞

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞ –ø–ª–∞–Ω–∞ (–ù–µ–¥–µ–ª—è 1-3). –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–æ –µ—Å—Ç—å —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º –æ—à–∏–±–∫–∞–º –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

## üéØ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–ª–∞–Ω—É

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü–ª–∞–Ω | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|-----------|------|------------|--------|
| Node.js + TypeScript + Prisma | ‚úÖ | ‚úÖ | –í—ã–ø–æ–ª–Ω–µ–Ω–æ |
| Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è | ‚úÖ | ‚úÖ | –í—ã–ø–æ–ª–Ω–µ–Ω–æ |
| PostgreSQL —Å—Ö–µ–º–∞ | ‚úÖ | ‚úÖ | –í—ã–ø–æ–ª–Ω–µ–Ω–æ |
| Telegram bot /start | ‚úÖ | ‚úÖ | –í—ã–ø–æ–ª–Ω–µ–Ω–æ |
| –î–æ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å Users | ‚úÖ | ‚úÖ | –í—ã–ø–æ–ª–Ω–µ–Ω–æ |
| –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∏–≥—Ä—ã | ‚úÖ | ‚ö†Ô∏è | **–ü—Ä–æ–±–ª–µ–º—ã** |

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ —Å–ª–æ—è–º

### Domain Layer (7/10) ‚úÖ
**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ [`GameStatus`](src/domain/game.ts:2) –∏ [`RegStatus`](src/domain/registration.ts:1)
- –î–æ–º–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ [`Game`](src/domain/game.ts:12) –∏ [`Registration`](src/domain/registration.ts:15) –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É—é—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
- –•–æ—Ä–æ—à–∞—è —Å–∏—Å—Ç–µ–º–∞ [`DomainError`](src/domain/errors.ts:2) —Å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–æ–¥–∞–º–∏

**–ü—Ä–æ–±–ª–µ–º—ã:**
```typescript
// ‚ùå –ù–∞—Ä—É—à–µ–Ω–∏–µ –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏–∏ - —Å—Ç–∞—Ç—É—Å –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é
game.status = GameStatus.closed;

// ‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥—ã
game.close();
```

### Application Layer (6/10) ‚ö†Ô∏è
**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- –•–æ—Ä–æ—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ use cases –≤ [`application/use-cases.ts`](src/application/use-cases.ts)
- –°–æ–±—ã—Ç–∏—è –¥–æ–º–µ–Ω–∞ —á–µ—Ä–µ–∑ [`event-publisher.ts`](src/shared/event-publisher.ts)  

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
```typescript
// ‚ùå RACE CONDITION: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
export async function joinGame(gameId: string, userId: string) {
  const game = await gameRepo.findById(gameId);
  const confirmedCount = await gameRepo.countConfirmed(gameId); // üö® –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
  
  // –ú–µ–∂–¥—É —ç—Ç–∏–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ –º–æ–∂–µ—Ç –ø—Ä–æ—Å–∫–æ—á–∏—Ç—å –¥—Ä—É–≥–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è!
  const status = confirmedCount < game.capacity ? RegStatus.confirmed : RegStatus.waitlisted;
}
```

**–ü–ª–∞–Ω –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–ª:**
```typescript
// ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
return prisma.$transaction(async (tx) => {
  await advisoryLock(tx, `game:${gameId}`);
  // –í—Å—è –ª–æ–≥–∏–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
});
```

### Infrastructure Layer (8/10) ‚úÖ
**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Repository –ø–∞—Ç—Ç–µ—Ä–Ω–∞
- –ß–µ—Ç–∫–∏–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ [`GameRepo`](src/infrastructure/repositories.ts:5) / [`RegistrationRepo`](src/infrastructure/repositories.ts:12)
- –•–æ—Ä–æ—à–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prisma

### Presentation Layer (5/10) ‚ö†Ô∏è
**–ü—Ä–æ–±–ª–µ–º—ã –≤ [`bot.ts`](src/bot.ts):**
```typescript
// ‚ùå –û–±—Ö–æ–¥ —Å–ª–æ—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è - –ø—Ä—è–º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ Prisma
await prisma.user.upsert({
  where: { telegramId },
  update: { name }, 
  create: { telegramId, name }
});

// ‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–µ—Ä–µ–∑ use case
await registerUser({ telegramId, name });
```

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. Race Conditions –≤ –∑–∞–ø–∏—Å–∏ –Ω–∞ –∏–≥—Ä—ã
**–ü—Ä–æ–±–ª–µ–º–∞:** [`joinGame`](src/application/use-cases.ts:19) –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
**–†–∏—Å–∫:** –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ capacity, loss of data integrity  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å `prisma.$transaction()` —Å advisory locks

### 2. Events –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```typescript
// ‚ùå –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
await registrationRepo.upsert(reg);
await eventPublisher.publish(evt('PlayerJoined', { gameId, userId, status }));
// –°–æ–±—ã—Ç–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```

### 3. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–ø–ª–∞—Ç—ã
**–í [`Game.isPaymentWindowOpen`](src/domain/game.ts:25):**
```typescript
get isPaymentWindowOpen(): boolean {
  return new Date() >= this.startsAt && (this.status === GameStatus.open || this.status === GameStatus.finished);
}
```

**–í [`markPayment`](src/application/use-cases.ts:84):**  
```typescript
if (!(new Date() >= game.startsAt) || ![GameStatus.open, GameStatus.finished].includes(game.status)) {
  // –î—É–±–ª–∏—Ä—É–µ—Ç—Å—è –ª–æ–≥–∏–∫–∞ –∏–∑ domain
}
```

## üìã –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏

| –§—É–Ω–∫—Ü–∏—è | –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–æ—Å—å | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|---------|---------------|-------------|-----------|
| `/newgame` –∫–æ–º–∞–Ω–¥–∞ | ‚úÖ | ‚ùå | –í—ã—Å–æ–∫–∏–π |
| –°–ø–∏—Å–æ–∫ –∏–≥—Ä `/games` | ‚úÖ | ‚ùå (–∑–∞–≥–ª—É—à–∫–∞) | –í—ã—Å–æ–∫–∏–π |
| –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ promote | ‚úÖ | ‚ùå | –°—Ä–µ–¥–Ω–∏–π |
| –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ | ‚úÖ | ‚ùå | –°—Ä–µ–¥–Ω–∏–π |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (4/10)

**–ü–æ–∫—Ä—ã—Ç–∏–µ:** –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã  
**–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- –¢–µ—Å—Ç—ã race conditions
- –¢–µ—Å—Ç—ã —Å–æ–±—ã—Ç–∏–π –¥–æ–º–µ–Ω–∞  
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã bot commands
- Edge cases (concurrent registrations)

## üìä –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º

### üî• –ö–†–ò–¢–ò–ß–ù–û (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ)
1. **–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ [`joinGame`](src/application/use-cases.ts:19)**
2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å advisory locks –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**  
3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å event publishing –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**

### ‚ö†Ô∏è –í–ê–ñ–ù–û (—Å–ª–µ–¥—É—é—â–∏–π —Å–ø—Ä–∏–Ω—Ç)
4. **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É [`/newgame`](src/bot.ts) –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤**
5. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å [`/games`](src/bot.ts:76) list functionality**
6. **–£–±—Ä–∞—Ç—å –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã Prisma –∏–∑ bot layer** 

### ‚ú® –£–õ–£–ß–®–ï–ù–ò–Ø (–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å)
7. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏—è –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏–∏ –≤ domain entities
8. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
9. –†–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

## üéØ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É

**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è **–£—Å–ª–æ–≤–Ω–æ –≥–æ—Ç–æ–≤**  

**–ë–ª–æ–∫–µ—Ä—ã –¥–ª—è –ù–µ–¥–µ–ª–∏ 4-7:**
- Race conditions —Å–¥–µ–ª–∞—é—Ç —Å–∏—Å—Ç–µ–º—É –Ω–µ–Ω–∞–¥–µ–∂–Ω–æ–π –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å—è—Ö
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `/newgame` –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–ø—É–Ω–∫—Ç—ã 1-3) –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ —Å–ª–µ–¥—É—é—â–∏–º —Ñ—É–Ω–∫—Ü–∏—è–º.