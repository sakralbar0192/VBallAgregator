# üìã –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–ê–Ø –û–¶–ï–ù–ö–ê –ü–†–û–ï–ö–¢–ê VBallAgregator

## üéØ –ö–û–ù–¢–ï–ö–°–¢ –ò –ü–û–°–¢–ê–ù–û–í–ö–ê –ü–†–û–ë–õ–ï–ú–´

**VBallAgregator** ‚Äî Telegram-–±–æ—Ç –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤–æ–ª–µ–π–±–æ–ª—å–Ω—ã—Ö –∏–≥—Ä —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞–º–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏. –ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **DDD (Domain-Driven Design)** —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —Å–ª–æ–∏: Domain ‚Üí Application ‚Üí Infrastructure.

---

## ‚úÖ –°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´

### 1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ–∏: Domain, Application, Infrastructure
- ‚úÖ Aggregate Root –ø–∞—Ç—Ç–µ—Ä–Ω (–∫–ª–∞—Å—Å [`Game`](src/domain/game.ts:12))
- ‚úÖ –î–æ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ —Å –∫–æ–¥–∞–º–∏ (–∫–ª–∞—Å—Å [`DomainError`](src/domain/errors.ts))
- ‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏ (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã [`GameRepo`](src/infrastructure/repositories.ts:5), [`RegistrationRepo`](src/infrastructure/repositories.ts:13))

### 2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π Prisma –¥–ª—è race conditions
- ‚úÖ –¢–µ—Å—Ç—ã –Ω–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å (—Ç–µ—Å—Ç [`should handle concurrent joinGame calls correctly`](src/tests/use-cases.test.ts:17))
- ‚úÖ Advisory locks –≤ –¥–æ–º–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–∏—Å–µ

### 3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
- ‚úÖ Unit –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (—Ñ–∞–π–ª—ã [`use-cases.test.ts`](src/tests/use-cases.test.ts), [`integration.test.ts`](src/tests/integration.test.ts))
- ‚úÖ –¢–µ—Å—Ç—ã race conditions –∏ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π Jest —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ESM

### 4. **Event-Driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**
- ‚úÖ EventBus –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π (–∫–ª–∞—Å—Å [`EventBus`](src/shared/event-bus.ts))
- ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π (—Ñ–∞–π–ª [`event-setup.ts`](src/infrastructure/event-setup.ts))
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è

### 5. **Graceful Shutdown**
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Ñ—É–Ω–∫—Ü–∏—è [`setupGracefulShutdown`](index.ts:58))
- ‚úÖ –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (–ë–î, Redis, Scheduler)

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π –∏ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é** üî¥
**–ü—Ä–æ–±–ª–µ–º–∞:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –Ω–æ —Ä–µ–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –º–æ–Ω–æ–ª–∏—Ç.

```
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (architecture_overview.md):
- Users Service
- Events Service  
- Notifications Service
- API Gateway

–†–µ–∞–ª—å–Ω–æ—Å—Ç—å:
- –û–¥–∏–Ω –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (index.ts)
- –í—Å–µ –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
```

**–†–∏—Å–∫:** –í—ã—Å–æ–∫–∏–π ‚Äî –ø—É—Ç–∞–Ω–∏—Ü–∞ –≤ –∫–æ–º–∞–Ω–¥–µ, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏–ª–∏ –Ω–∞—á–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã (–µ—Å–ª–∏ —ç—Ç–æ –ø–ª–∞–Ω).

---

### 2. **–°–º–µ—à–∏–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤ –≤ use-cases** üî¥
**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è [`createGame`](src/application/use-cases.ts:167) —Å–º–µ—à–∏–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É:

```typescript
// –°—Ç—Ä–æ–∫–∞ 191: –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
const organizer = await (gameRepo as any).getOrganizerByUserId(data.organizerId);

// –°—Ç—Ä–æ–∫–∞ 196: —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–º–µ–Ω–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏
const g = new Game(uuid(), organizer.id, ...);

// –°—Ç—Ä–æ–∫–∞ 208: –≤—ã–∑–æ–≤ –¥—Ä—É–≥–æ–≥–æ use-case (—Ü–∏–∫–ª–∏—á–µ—Å–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å)
await scheduleGameReminders(g.id);
```

**–†–∏—Å–∫:** –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –Ω–∞—Ä—É—à–µ–Ω–∏–µ SRP.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å `GameApplicationService` –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ (–∫–∞–∫ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ –¥–ª—è `markPayment` –∏ `joinGame`).

---

### 3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –∫–æ–º–∞–Ω–¥** üî¥
**–ü—Ä–æ–±–ª–µ–º–∞:** –í [`command-handlers.ts`](src/bot/command-handlers.ts:28) –±–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:

```typescript
try {
  const result = await joinGame(gameId, user.id!);
  // ...
} catch (error: any) {
  await ctx.reply(`–û—à–∏–±–∫–∞: ${error.message}`);  // ‚ùå –°–ª–∏—à–∫–æ–º –æ–±—â–µ–µ
}
```

**–†–∏—Å–∫:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –Ω–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–µ—Ç –º–µ—Ç—Ä–∏–∫.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å `ErrorHandler` —Å –º–∞–ø–ø–∏–Ω–≥–æ–º –¥–æ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

---

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–µ** üî¥
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–º–∞–Ω–¥—ã –ø–∞—Ä—Å—è—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤—Ä—É—á–Ω—É—é:

```typescript
// –°—Ç—Ä–æ–∫–∞ 72-74 (bot.ts)
const args = ctx.message.text.split(' ');
if (args.length < 2) {
  return ctx.reply('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /join <game_id>');
}
const gameId = args[1] || "";  // ‚ùå –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π
```

**–†–∏—Å–∫:** –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ ID –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ë–î, –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `zod` –∏–ª–∏ `joi` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏.

---

### 5. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö** üü°
**–ü—Ä–æ–±–ª–µ–º–∞:** –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –ª–æ–≥–∏—Ä—É—é—Ç —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ:

```typescript
// –°—Ç—Ä–æ–∫–∞ 45-47 (event-setup.ts)
async function handleGameReminder24h(event: any) {
  const { gameId } = event.payload;
  logger.info('Processing GameReminder24h', { gameId });
  // ‚ùå –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
}
```

**–†–∏—Å–∫:** –°–ª–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –ø–æ—á–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏—Å—å.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —É—Å–ø–µ—Ö/–æ—à–∏–±–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞–∂–¥–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.

---

### 6. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö —Å–æ–±—ã—Ç–∏–π** üü°
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–±—ã—Ç–∏—è —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ `any`:

```typescript
// –°—Ç—Ä–æ–∫–∞ 45 (event-setup.ts)
async function handleGameReminder24h(event: any) {  // ‚ùå any
  const { gameId } = event.payload;
}
```

**–†–∏—Å–∫:** –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤, –ª–µ–≥–∫–æ –æ—à–∏–±–∏—Ç—å—Å—è –ø—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å —Ç–∏–ø—ã –¥–ª—è —Å–æ–±—ã—Ç–∏–π (discriminated union).

---

### 7. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ë–î –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** üü°
**–ü—Ä–æ–±–ª–µ–º–∞:** –í [`schema.prisma`](prisma/schema.prisma:87) –µ—Å—Ç—å –∏–Ω–¥–µ–∫—Å —Ç–æ–ª—å–∫–æ –Ω–∞ Registration:

```prisma
@@index([gameId, status, createdAt])
```

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–Ω–¥–µ–∫—Å—ã –Ω–∞:**
- `User.telegramId` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –±–æ—Ç–∞)
- `Game.organizerId` (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏–≥—Ä –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞)
- `Registration.userId` (–ø–æ–∏—Å–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

**–†–∏—Å–∫:** –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ —Ä–æ—Å—Ç–µ –¥–∞–Ω–Ω—ã—Ö.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã.

---

### 8. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting** üü°
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç spam-–∞—Ç–∞–∫ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞.

**–†–∏—Å–∫:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å 1000 `/join` –∫–æ–º–∞–Ω–¥ –∑–∞ —Å–µ–∫—É–Ω–¥—É.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å rate limiting –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥.

---

## üü† –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ù–ï–î–û–°–¢–ê–¢–ö–ò

### 1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Query Object Pattern**
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã –ø–æ –∫–æ–¥—É:

```typescript
// command-handlers.ts, —Å—Ç—Ä–æ–∫–∞ 107-117
const registrations = await prisma.registration.findMany({
  where: { userId: user.id },
  include: { game: { include: { organizer: true } } },
  orderBy: { createdAt: 'desc' }
});
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å Query Objects –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

---

### 2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Value Objects**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–µ —Ç–∏–ø—ã –≤–µ–∑–¥–µ (—Å—Ç—Ä–æ–∫–∏ –¥–ª—è ID, —Å—Ç–∞—Ç—É—Å–æ–≤):

```typescript
// –õ—É—á—à–µ –±—ã–ª–æ –±—ã:
class GameId extends ValueObject { ... }
class RegistrationStatus extends ValueObject { ... }
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å Value Objects –¥–ª—è —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

---

### 3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Specification Pattern**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã –ø–æ –∫–æ–¥—É:

```typescript
// game.ts, —Å—Ç—Ä–æ–∫–∞ 34-37
ensureCanJoin(confirmedCount: number) {
  if (this.status !== GameStatus.open) throw ...
  if (this.startsAt <= new Date()) throw ...
  if (confirmedCount >= this.capacity) throw ...
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Specification –¥–ª—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª.

---

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ CQRS**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–º–∞–Ω–¥—ã –∏ –∑–∞–ø—Ä–æ—Å—ã —Å–º–µ—à–∞–Ω—ã –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ Command –∏ Query handlers –¥–ª—è –ª—É—á—à–µ–π –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏.

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï –í–ê–†–ò–ê–ù–¢–û–í –ê–†–•–ò–¢–ï–ö–¢–£–†–´

| –ê—Å–ø–µ–∫—Ç | –¢–µ–∫—É—â–µ–µ (–ú–æ–Ω–æ–ª–∏—Ç) | –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã | –ú–æ–¥—É–ª—å–Ω—ã–π –º–æ–Ω–æ–ª–∏—Ç |
|--------|-------------------|--------------|-------------------|
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å** | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è | –û—Ç–ª–∏—á–Ω–∞—è | –•–æ—Ä–æ—à–∞—è |
| **–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏** | –ë—ã—Å—Ç—Ä–æ | –ú–µ–¥–ª–µ–Ω–Ω–æ | –°—Ä–µ–¥–Ω–µ–µ |
| **–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å** | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è |
| **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** | –•–æ—Ä–æ—à–∞—è | –û—Ç–ª–∏—á–Ω–∞—è | –û—Ç–ª–∏—á–Ω–∞—è |
| **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è** | ‚úÖ –î–ª—è MVP | ‚ùå –†–∞–Ω–æ | ‚úÖ –õ—É—á—à–∏–π –≤—ã–±–æ—Ä |

---

## üöÄ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ü–†–ò–û–†–ò–¢–ï–¢–ê–ú

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï (1-2 –Ω–µ–¥–µ–ª–∏)

1. **–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤ –ë–î**
   ```prisma
   model User {
     telegramId BigInt @unique @db.BigInt
     @@index([telegramId])
   }
   
   model Game {
     @@index([organizerId])
   }
   
   model Registration {
     @@index([userId])
   }
   ```

2. **–°–æ–∑–¥–∞—Ç—å ErrorHandler –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ –æ—à–∏–±–æ–∫**
   ```typescript
   // src/shared/error-handler.ts
   export class ErrorHandler {
     static mapToUserMessage(error: Error): string {
       if (error instanceof DomainError) {
         return this.domainErrorMessages[error.code] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
       }
       return '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.';
     }
   }
   ```

3. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
   ```typescript
   import { z } from 'zod';
   
   const JoinGameSchema = z.object({
     gameId: z.string().uuid(),
     userId: z.string().uuid()
   });
   ```

### üü° –í–ê–ñ–ù–´–ï (2-4 –Ω–µ–¥–µ–ª–∏)

4. **–¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è**
   ```typescript
   type DomainEvent = 
     | { type: 'GameCreated'; payload: GameCreatedPayload }
     | { type: 'PlayerJoined'; payload: PlayerJoinedPayload }
     | ...
   ```

5. **–î–æ–±–∞–≤–∏—Ç—å rate limiting**
   ```typescript
   import rateLimit from 'telegraf-ratelimit';
   bot.use(rateLimit({ in: 2, out: 1 }));
   ```

6. **–£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö —Å–æ–±—ã—Ç–∏–π**
   ```typescript
   try {
     await notificationService.sendBatch(notifications);
     logger.info('Notifications sent', { count: notifications.length });
   } catch (error) {
     logger.error('Failed to send notifications', { error, gameId });
   }
   ```

### üü¢ –ñ–ï–õ–ê–¢–ï–õ–¨–ù–´–ï (1 –º–µ—Å—è—Ü)

7. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å use-cases –≤ Application Services**
   - –°–æ–∑–¥–∞—Ç—å `UserApplicationService`
   - –°–æ–∑–¥–∞—Ç—å `OrganizerApplicationService`
   - –£–¥–∞–ª–∏—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

8. **–î–æ–±–∞–≤–∏—Ç—å Query Objects**
   ```typescript
   // src/application/queries/GetUserRegistrationsQuery.ts
   export class GetUserRegistrationsQuery {
     constructor(public userId: string) {}
   }
   ```

9. **–û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é**
   - –£—Ç–æ—á–Ω–∏—Ç—å, —á—Ç–æ —ç—Ç–æ –º–æ–Ω–æ–ª–∏—Ç, –∞ –Ω–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã
   - –î–æ–±–∞–≤–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å event flow

10. **–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏**
    ```typescript
    // src/shared/metrics.ts
    export const metrics = {
      gamesCreated: new Counter(...),
      registrationsProcessed: new Counter(...),
      notificationsSent: new Counter(...)
    };
    ```

---

## üìà –ü–õ–ê–ù –ú–ò–ì–†–ê–¶–ò–ò –ù–ê –ú–û–î–£–õ–¨–ù–´–ô –ú–û–ù–û–õ–ò–¢

–ï—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è:

**–§–∞–∑–∞ 1 (–ú–µ—Å—è—Ü 1):** –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –º–æ–¥—É–ª–∏
```
src/
  modules/
    users/
      domain/
      application/
      infrastructure/
    games/
      domain/
      application/
      infrastructure/
    notifications/
      domain/
      application/
      infrastructure/
```

**–§–∞–∑–∞ 2 (–ú–µ—Å—è—Ü 2):** –î–æ–±–∞–≤–∏—Ç—å Event Bus –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏

**–§–∞–∑–∞ 3 (–ú–µ—Å—è—Ü 3):** –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –≤—ã–¥–µ–ª–∏—Ç—å –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã

---

## üéØ –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----------|--------|-----------|
| **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** | 7/10 | –•–æ—Ä–æ—à–µ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–µ–≤, –Ω–æ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ –≤ use-cases |
| **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** | 8/10 | –•–æ—Ä–æ—à–∏–µ —Ç–µ—Å—Ç—ã, –Ω–æ –Ω–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –±–æ—Ç–∞ |
| **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** | 5/10 | –ú–æ–Ω–æ–ª–∏—Ç, –Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏ —Ä–æ—Å—Ç–µ |
| **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** | 4/10 | –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** | 5/10 | –ë–∞–∑–æ–≤–∞—è, –Ω–µ—Ç –º–∞–ø–ø–∏–Ω–≥–∞ –æ—à–∏–±–æ–∫ |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | 6/10 | –ï—Å—Ç—å, –Ω–æ –Ω–µ–ø–æ–ª–Ω–æ–µ |
| **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | 5/10 | –ù–µ—Ç rate limiting, –≤–∞–ª–∏–¥–∞—Ü–∏–∏ |

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: 6.3/10** ‚úÖ –•–æ—Ä–æ—à–∏–π MVP, –Ω—É–∂–Ω—ã —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è production.

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç **—Å–æ–ª–∏–¥–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—É—é –æ—Å–Ω–æ–≤—É** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º DDD –∏ Event-Driven –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã ‚Äî —ç—Ç–æ **–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ** (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤–∞–ª–∏–¥–∞—Ü–∏—è, rate limiting) –∏ **–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ** (–Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏).

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø—É—Ç—å:**
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–∏–Ω–¥–µ–∫—Å—ã, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫)
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø–∏–∑–∞—Ü–∏—é –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é
3. ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å use-cases –≤ Application Services
4. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
5. ‚úÖ –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –º–æ–¥—É–ª—å–Ω—ã–π –º–æ–Ω–æ–ª–∏—Ç

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ production —Å —É—á–µ—Ç–æ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –≤—ã—à–µ.